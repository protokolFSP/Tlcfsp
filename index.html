<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TLC FSP ‚Äì Liste</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --border:#e9e9e9;
      --muted:#6b6b6b;
      --bg:#ffffff;
      --hover:#f7f7f7;

      --active:#cfe9ff;
      --activeGlow: 0 0 0 2px rgba(43,124,255,.34) inset, 0 12px 26px rgba(43,124,255,.14);

      --shadow: 0 12px 30px rgba(0,0,0,.12);
      --blue:#2b7cff;

      --blueGlow: 0 0 0 4px rgba(43,124,255,.24), 0 10px 22px rgba(43,124,255,.10);
    }

    /* ‚úÖ 21-23 ile aynƒ±: sayfa ortalama + scroll container */
    html, body{
      height: 100%;
      overscroll-behavior-y: none;
      background: var(--bg);
    }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      overflow: hidden;
      color:#111;
      line-height: 1.10;
    }
    #scrollArea{
      height: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      padding: 18px;
      max-width: 980px;
      margin: 0 auto;
    }

    #appScale{
      transform-origin: top left;
      will-change: transform;
    }

    .pageTitle{
      font-size: 1.6rem;
      font-weight: 700;
      color: #0b5fff;
      background: #f1f5ff;
      padding: 12px 16px;
      border-radius: 14px;
      margin-bottom: 14px;
    }

    .navRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 0 0 12px 0;
    }
    .navLink{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      color:#111;
      text-decoration:none;
      font-size: .95rem;
      line-height: 1;
      user-select:none;
      transition: background .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .navLink:hover{ background: var(--hover); }
    .navLink.on{
      border-color:#2b7cff;
      background: rgba(43,124,255,.10);
      box-shadow: 0 0 0 3px rgba(43,124,255,.16) inset;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    #search{
      flex: 1 1 520px;
      min-width: 220px;
      padding: 10px 12px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      font-size: 1rem;
      outline: none;
    }

    #resetBtn{
      padding: 10px 16px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      background: white;
      cursor: pointer;
      font-size: 1rem;
      flex: 0 0 auto;
    }
    #resetBtn:hover{ background: var(--hover); }

    /* ‚úÖ Zoom (ikonlu) */
    .zoomWrap{
      display:flex;
      align-items:center;
      gap: 24px;
      margin-left: 14px;
      padding: 6px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      background: white;
      user-select:none;
      flex: 0 0 auto;
    }
    .zoomBtn{
      height: 36px;
      width: 48px;
      border-radius: 12px;
      border: 1px solid #d8d8d8;
      background: white;
      cursor: pointer;
      line-height: 1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      transition: opacity .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease, filter .15s ease;
    }
    .zoomBtn:hover{ background: var(--hover); }
    .zoomBtn:disabled{ opacity: .35; cursor: default; }

    .zoomBtn svg{
      width: 20px;
      height: 20px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: .95;
    }

    .zoomBtn.zoomOut,
    .zoomBtn.zoomIn{
      opacity: .55;
      filter: saturate(1.2);
      color: #111;
    }
    .zoomBtn.enabled.zoomOut{
      opacity: 1;
      background: rgba(255, 149, 0, .18);
      border-color: rgba(255, 149, 0, .70);
      box-shadow: 0 0 0 3px rgba(255, 149, 0, .16) inset, 0 8px 18px rgba(255, 149, 0, .12);
      filter: saturate(1.7);
      color: #b45309;
    }
    .zoomBtn.enabled.zoomIn{
      opacity: 1;
      background: rgba(34, 197, 94, .18);
      border-color: rgba(34, 197, 94, .70);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, .16) inset, 0 8px 18px rgba(34, 197, 94, .12);
      filter: saturate(1.7);
      color: #15803d;
    }

    #meta{
      color: var(--muted);
      font-size: .95rem;
      margin: 6px 0 12px 2px;
      line-height: 1.05;
    }

    /* ‚úÖ Top cards (hits) */
    .tops{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      margin: 0 0 12px 0;
    }
    .topCard{
      flex: 1 1 360px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
      overflow: hidden;
    }
    .topHead{
      padding: 10px 12px;
      font-weight: 700;
      color: #0b5fff;
      background: #f6f9ff;
      border-bottom: 1px solid var(--border);
      line-height: 1.05;
    }
    .topList{
      padding: 6px;
    }
    .topItem{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: white;
      cursor: pointer;
      text-align:left;
      line-height: 1.05;
    }
    .topItem:hover{
      background: var(--hover);
      border-color: #e6e6e6;
    }
    .topTitle{
      flex: 1 1 auto;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: .98rem;
      font-weight: 520;
    }
    .topCount{
      flex: 0 0 auto;
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      font-size: .92rem;
      white-space: nowrap;
    }
    .topEmpty{
      padding: 10px 12px;
      color: var(--muted);
      font-size: .95rem;
      line-height: 1.05;
    }

    .headerRow, .itemRow{
      display: grid;
      grid-template-columns: minmax(0, 1fr) 8ch 36px 36px 36px;
      align-items: center;
      column-gap: 8px;
    }

    .headerRow{
      padding: 6px 8px;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      font-size: .92rem;
      line-height: 1.05;
    }

    .titleHead, .durHead{
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      width: 100%;
    }
    .titleHead{ justify-content:flex-start; }
    .durHead{ justify-content:flex-end; }

    .headIconCell{
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }

    .sortBtn{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#111;
      flex: 0 0 auto;
    }
    .sortBtn:hover{ background: var(--hover); }
    .sortBtn svg{ width:14px; height:14px; }
    .sortBtn.on{
      border-color:#2b7cff;
      box-shadow: 0 0 0 3px rgba(43,124,255,.12) inset;
    }

    #list{ border-bottom: 1px solid var(--border); }

    .itemRow{
      padding: 4px 8px;
      border-bottom: 1px solid #ececec;
      cursor: pointer;
      background: #f7f7f7;
    }
    #list .itemRow:nth-child(even){ background: #eeeeee; }
    .itemRow:hover{ background: var(--hover); }

    .itemRow.active{
      background: var(--active) !important;
      box-shadow: var(--activeGlow);
      position: relative;
    }
    .itemRow.active:hover{ background: var(--active) !important; }
    .itemRow.active::before{
      content:"";
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:4px;
      background: var(--blue);
      border-radius: 4px;
    }

    .title{
      font-size: 1.02rem;
      font-weight: 500;
      line-height: 1.02;
      min-width: 0;
    }

    .dur{
      text-align:right;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      font-size: .95rem;
      user-select:none;
      white-space: nowrap;
      line-height: 1.00;
    }

    @media (max-width: 680px){
      #scrollArea{ padding: 14px; }
      .title{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      #search{ flex: 1 1 100%; }
      .zoomWrap{ margin-left: 0; }
    }

    .iconBtn{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: pointer;
      flex: 0 0 auto;
      user-select:none;
      justify-self: center;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .iconBtn:hover{ background: var(--hover); }
    .iconBtn.on{
      border-color: #2b7cff;
      background: rgba(43,124,255,.10);
      box-shadow: var(--blueGlow);
    }
    .iconBtn svg{ width: 14px; height: 14px; opacity: .9; }

    .filterBtn{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#111;
    }
    .filterBtn:hover{ background: var(--hover); }
    .filterBtn.on{
      border-color:#2b7cff;
      box-shadow: 0 0 0 3px rgba(43,124,255,.12) inset;
    }
    .filterBtn svg{ width:14px; height:14px; }

    #floatingPlayer{
      position: fixed;
      left: max(18px, env(safe-area-inset-left));
      bottom: max(18px, env(safe-area-inset-bottom));
      width: min(720px, calc(100vw - 36px));
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
      z-index: 9999;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
      transform-origin: top left;
      will-change: transform;
      transition: opacity .18s ease;
      touch-action: none;
    }

    #floatingPlayer.hiddenWhileTyping{
      opacity: 0;
      pointer-events: none;
    }

    #fpHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
      background: #fbfbfb;
      cursor: grab;
      user-select:none;
      gap: 10px;
      touch-action: none;
    }

    #fpTitle{
      font-weight: 600;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1 1 auto;
      min-width: 0;
      line-height: 1.05;
    }

    #fpHeaderRight{
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .miniBtn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid #d8d8d8;
      background: white;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .miniBtn:hover{ background: var(--hover); }
    .miniBtn svg{ width:16px; height:16px; }

    .speedWrap{
      display:flex;
      align-items:center;
      gap: 6px;
      padding: 4px;
      border: 1px solid #d8d8d8;
      border-radius: 14px;
      background: white;
      user-select:none;
    }
    .speedCtlBtn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid #d8d8d8;
      background: white;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      line-height: 1;
    }
    .speedCtlBtn:hover{ background: var(--hover); }

    .speedValue{
      min-width: 56px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid #d8d8d8;
      background: white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-variant-numeric: tabular-nums;
      font-weight: 650;
      padding: 0 10px;
      cursor: default;
    }
    .speedValue.on{
      border-color:#2b7cff;
      box-shadow: 0 0 0 3px rgba(43,124,255,.12) inset;
    }

    #fpBody{ padding: 10px 12px 12px 12px; }

    #status{
      margin: 8px 2px 0 2px;
      color: var(--muted);
      font-size: .92rem;
      line-height: 1.05;
    }

    .plyr--audio .plyr__controls{
      border-radius: 12px;
      flex-wrap: wrap;
      row-gap: 8px;
    }
    .plyr--audio .plyr__controls .plyr__progress{
      flex: 1 1 100%;
      min-width: 0;
    }

    @media (max-width: 680px){
      #fpHeader{ flex-wrap: wrap; gap: 8px; }
      #fpTitle{
        flex: 1 1 100%;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
      }
      #fpHeaderRight{
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
</head>

<body>
  <div id="scrollArea">
    <div id="appScale">
      <h1 class="pageTitle">TLC FSP</h1>

      <!-- ‚úÖ Nav sƒ±ralamasƒ± aynen korunuyor -->
      <nav class="navRow" aria-label="Sayfalar">
        <a class="navLink" href="https://protokolfsp.github.io/fsp-audio/">G√ºncel</a>
        <a class="navLink" href="https://protokolfsp.github.io/FSP2022-23/">2021‚Äì23</a>
        <a class="navLink" href="https://protokolfsp.github.io/All-in-One/">All-in-One</a>
        <a class="navLink" href="https://protokolfsp.github.io/Tlcfsp/">TLC</a>
        <a class="navLink" href="https://protokolfsp.github.io/MenschiB/">MenschiB</a>
      </nav>

      <div class="topbar">
        <input id="search" type="text" placeholder="Arama..." />
        <button id="resetBtn" type="button">Hepsi</button>

        <!-- ‚úÖ Zoom ikonlarƒ± -->
        <div class="zoomWrap" aria-label="G√∂r√ºn√ºm">
          <button id="zoomOutBtn" class="zoomBtn zoomOut" type="button" aria-label="K√º√ß√ºlt">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="11" cy="11" r="6"></circle>
              <path d="M20 20l-3.5-3.5"></path>
              <path d="M8.5 11h5"></path>
            </svg>
          </button>

          <button id="zoomInBtn" class="zoomBtn zoomIn" type="button" aria-label="B√ºy√ºt">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="11" cy="11" r="6"></circle>
              <path d="M20 20l-3.5-3.5"></path>
              <path d="M11 8.5v5"></path>
              <path d="M8.5 11h5"></path>
            </svg>
          </button>
        </div>
      </div>

      <div id="meta">G√∂r√ºn…ôn: 0 / Toplam: 0</div>

      <!-- ‚úÖ En √ßok dinlenen / indirilen -->
      <div id="tops" class="tops" aria-label="ƒ∞statistikler">
        <div class="topCard">
          <div class="topHead">En √ßok dinlenen</div>
          <div id="topPlayed" class="topList"></div>
        </div>
        <div class="topCard">
          <div class="topHead">En √ßok indirilen</div>
          <div id="topDownloaded" class="topList"></div>
        </div>
      </div>

      <div class="headerRow">
        <div class="colTitle">
          <div class="titleHead">
            <span>Kayƒ±t</span>
            <button id="sortDateBtn" class="sortBtn" type="button" title="Tarihe g√∂re sƒ±rala (dosya sonu)">
              <svg id="sortDateIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
            </button>
          </div>
        </div>

        <div class="colDur" style="text-align:right;">
          <div class="durHead">
            <span>S√ºre</span>
            <button id="sortDurBtn" class="sortBtn" type="button" title="S√ºreye g√∂re sƒ±rala">
              <svg id="sortDurIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
            </button>
          </div>
        </div>

        <div class="headIconCell">
          <button id="filterFav" class="filterBtn" title="Favoriler filtrele" type="button" aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l3.1 6.3 6.9 1-5 4.9 1.2 6.8L12 17.8 5.8 21l1.2-6.8-5-4.9 6.9-1L12 2z"/>
            </svg>
          </button>
        </div>

        <div class="headIconCell">
          <button id="filterSel" class="filterBtn" title="Se√ßilenler filtrele" type="button" aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
          </button>
        </div>

        <div class="headIconCell" aria-hidden="true"></div>
      </div>

      <div id="list"></div>
      <div id="status"></div>
    </div>
  </div>

  <div id="floatingPlayer" role="region" aria-label="Oynatƒ±cƒ±">
    <div id="fpHeader" title="S√ºr√ºkle">
      <div id="fpTitle">Bir kayƒ±t se√ß...</div>
      <div id="fpHeaderRight">
        <div id="speedWrap" class="speedWrap" aria-label="Hƒ±z">
          <button id="slowBtn" class="speedCtlBtn" type="button" title="Yava≈ülat (üê¢)">üê¢</button>
          <div id="speedValue" class="speedValue on" title="Oynatma hƒ±zƒ±">1√ó</div>
          <button id="fastBtn" class="speedCtlBtn" type="button" title="Hƒ±zlandƒ±r (üêá)">üêá</button>
        </div>

        <button id="prevBtn" class="miniBtn" type="button" title="√ñnceki">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 20L9 12l10-8v16z"/><path d="M5 19V5"/>
          </svg>
        </button>
        <button id="nextBtn" class="miniBtn" type="button" title="Sonraki">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 4l10 8-10 8V4z"/><path d="M19 5v14"/>
          </svg>
        </button>
      </div>
    </div>
    <div id="fpBody">
      <audio id="player" class="js-player" controls preload="metadata"></audio>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <script>
    // =========================
    // Archive source
    // =========================
    const ARCHIVE_ID = "Tlcfsp";
    const BASE = `https://archive.org/download/${ARCHIVE_ID}/`;
    const DL_PROXY = "https://fspdownload.protokolfsp.workers.dev/";

    // =========================
    // DOM
    // =========================
    const listEl   = document.getElementById("list");
    const searchEl = document.getElementById("search");
    const metaEl   = document.getElementById("meta");
    const statusEl = document.getElementById("status");

    const topPlayedEl = document.getElementById("topPlayed");
    const topDownloadedEl = document.getElementById("topDownloaded");

    const appScaleEl = document.getElementById("appScale");
    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const zoomInBtn  = document.getElementById("zoomInBtn");

    const fp = document.getElementById("floatingPlayer");
    const fpHeader = document.getElementById("fpHeader");
    const fpTitle = document.getElementById("fpTitle");

    const playerEl = document.getElementById("player");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const slowBtn = document.getElementById("slowBtn");
    const fastBtn = document.getElementById("fastBtn");
    const speedValueEl = document.getElementById("speedValue");

    const filterFavBtn  = document.getElementById("filterFav");
    const filterSelBtn  = document.getElementById("filterSel");
    const resetBtn      = document.getElementById("resetBtn");

    const sortDurBtn  = document.getElementById("sortDurBtn");
    const sortDurIcon = document.getElementById("sortDurIcon");
    const sortDateBtn  = document.getElementById("sortDateBtn");
    const sortDateIcon = document.getElementById("sortDateIcon");

    const plyr = new Plyr(playerEl, {
      seekTime: 5,
      controls: ["rewind","play","fast-forward","progress","current-time","duration","mute","volume"]
    });

    // =========================
    // LocalStorage keys (ID bazlƒ±)
    // =========================
    const LS = {
      favs:  `fsp.favs.${ARCHIVE_ID}.v1`,
      sels:  `fsp.sels.${ARCHIVE_ID}.v1`,
      pos:   `fsp.fp.pos.${ARCHIVE_ID}.v1`,
      durs:  `fsp.durs.${ARCHIVE_ID}.v1`,
      sortMode: `fsp.sort.mode.${ARCHIVE_ID}.v2`,
      sortDirDur: `fsp.sort.dur.dir.${ARCHIVE_ID}.v2`,
      sortDirDate: `fsp.sort.date.dir.${ARCHIVE_ID}.v2`,
      cacheItems: `fsp.cache.items.${ARCHIVE_ID}.v1`,
      cacheFp:    `fsp.cache.fp.${ARCHIVE_ID}.v1`,
      speed: `fsp.speed.${ARCHIVE_ID}.v1`,
      zoom:  `fsp.ui.zoom.${ARCHIVE_ID}.v1`,

      // ‚úÖ hits
      plays: `fsp.stats.plays.${ARCHIVE_ID}.v1`,
      downs: `fsp.stats.downs.${ARCHIVE_ID}.v1`
    };

    const loadMap = (k) => { try { return JSON.parse(localStorage.getItem(k) || "{}"); } catch { return {}; } };
    const saveMap = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    let favs  = loadMap(LS.favs);
    let sels  = loadMap(LS.sels);
    let durs  = loadMap(LS.durs);

    let plays = loadMap(LS.plays);
    let downs = loadMap(LS.downs);

    let filterFav  = false;
    let filterSel  = false;

    let items = [];
    let activeId = null;

    let sortMode = localStorage.getItem(LS.sortMode) || "title";
    let durSortDir  = (localStorage.getItem(LS.sortDirDur) === "desc") ? "desc" : "asc";
    let dateSortDir = (localStorage.getItem(LS.sortDirDate) === "desc") ? "desc" : "asc";

    let lastFp = localStorage.getItem(LS.cacheFp) || "";

    // =========================
    // SPEED
    // =========================
    const SPEEDS = [0.5, 0.75, 0.9, 1, 1.25, 1.5, 1.75, 2.0, 2.27];
    let speedIndex = SPEEDS.indexOf(1);

    function fmtSpeed(v){
      const s = (Math.round(v * 100) / 100).toString();
      return s.replace(/\.0+$/,"") + "√ó";
    }
    function setSpeedUI(v){
      speedValueEl.textContent = fmtSpeed(v);
      speedValueEl.classList.add("on");
      slowBtn.disabled = (speedIndex <= 0);
      fastBtn.disabled = (speedIndex >= SPEEDS.length - 1);
      slowBtn.style.opacity = slowBtn.disabled ? 0.45 : 1;
      fastBtn.style.opacity = fastBtn.disabled ? 0.45 : 1;
    }
    function applySpeedByIndex(idx){
      speedIndex = Math.max(0, Math.min(SPEEDS.length - 1, idx));
      const v = SPEEDS[speedIndex];
      plyr.speed = v;
      localStorage.setItem(LS.speed, String(v));
      setSpeedUI(v);
    }
    function restoreSpeed(){
      const saved = Number(localStorage.getItem(LS.speed) || "1");
      if (Number.isFinite(saved)){
        const i = SPEEDS.findIndex(x => Math.abs(x - saved) < 0.001);
        applySpeedByIndex(i === -1 ? SPEEDS.indexOf(1) : i);
      } else {
        applySpeedByIndex(SPEEDS.indexOf(1));
      }
    }
    slowBtn.addEventListener("click", (e) => { e.stopPropagation(); applySpeedByIndex(speedIndex - 1); });
    fastBtn.addEventListener("click", (e) => { e.stopPropagation(); applySpeedByIndex(speedIndex + 1); });

    // =========================
    // ZOOM (player dahil) + dblclick/doubletap reset
    // =========================
    const ZOOMS = [0.85, 0.9, 0.95, 1, 1.05, 1.1, 1.15, 1.2];
    let zoomIndex = ZOOMS.indexOf(1);
    let uiScale = 1;
    let useTransformScale = false;

    function setZoomUI(v){
      const pct = Math.round(v * 100) + "%";
      zoomOutBtn.disabled = (zoomIndex <= 0);
      zoomInBtn.disabled  = (zoomIndex >= ZOOMS.length - 1);

      zoomOutBtn.classList.toggle("enabled", !zoomOutBtn.disabled);
      zoomInBtn.classList.toggle("enabled", !zoomInBtn.disabled);

      zoomOutBtn.title = `K√º√ß√ºlt (${pct})`;
      zoomInBtn.title  = `B√ºy√ºt (${pct})`;
      zoomOutBtn.setAttribute("aria-label", `K√º√ß√ºlt (${pct})`);
      zoomInBtn.setAttribute("aria-label", `B√ºy√ºt (${pct})`);
    }

    function applyZoomByIndex(idx){
      zoomIndex = Math.max(0, Math.min(ZOOMS.length - 1, idx));
      const v = ZOOMS[zoomIndex];
      uiScale = v;

      useTransformScale = !(window.CSS && CSS.supports && CSS.supports("zoom", "1"));

      if (!useTransformScale){
        document.documentElement.style.zoom = String(v);
        appScaleEl.style.transform = "";
        fp.style.transform = "";
      } else {
        document.documentElement.style.zoom = "";
        appScaleEl.style.transform = `scale(${v})`;
        fp.style.transform = `scale(${v})`;
      }

      localStorage.setItem(LS.zoom, String(v));
      setZoomUI(v);
      setTimeout(() => clampPlayerToViewport(), 0);
    }

    function restoreZoom(){
      const saved = Number(localStorage.getItem(LS.zoom) || "1");
      if (Number.isFinite(saved)){
        const i = ZOOMS.findIndex(x => Math.abs(x - saved) < 0.001);
        applyZoomByIndex(i === -1 ? ZOOMS.indexOf(1) : i);
      } else {
        applyZoomByIndex(ZOOMS.indexOf(1));
      }
    }

    function resetZoom100(){
      applyZoomByIndex(ZOOMS.indexOf(1));
    }

    function attachDoubleTapReset(el){
      el.addEventListener("dblclick", (e) => { e.preventDefault(); resetZoom100(); });

      let lastTap = 0;
      el.addEventListener("touchend", (e) => {
        const now = Date.now();
        if (now - lastTap < 320){
          e.preventDefault();
          resetZoom100();
          lastTap = 0;
          return;
        }
        lastTap = now;
      }, { passive: false });
    }

    zoomOutBtn.addEventListener("click", (e) => { e.stopPropagation(); applyZoomByIndex(zoomIndex - 1); });
    zoomInBtn.addEventListener("click", (e) => { e.stopPropagation(); applyZoomByIndex(zoomIndex + 1); });
    attachDoubleTapReset(zoomOutBtn);
    attachDoubleTapReset(zoomInBtn);

    // =========================
    // SEARCH: player sakla
    // =========================
    function setTypingMode(on){
      fp.classList.toggle("hiddenWhileTyping", !!on);
    }
    searchEl.addEventListener("focus", () => setTypingMode(true));
    searchEl.addEventListener("blur",  () => setTypingMode(false));

    // =========================
    // Hits (Top list)
    // =========================
    function bump(map, id){
      if (!id) return;
      const v = Number(map[id] || 0);
      map[id] = Number.isFinite(v) ? (v + 1) : 1;
    }

    function getTop(map, limit){
      const byId = new Map(items.map(it => [it.id, it]));
      return Object.keys(map)
        .map(id => ({ id, n: Number(map[id] || 0) }))
        .filter(x => x.n > 0 && byId.has(x.id))
        .sort((a,b) => b.n - a.n)
        .slice(0, limit);
    }

    function renderTop(){
      const topP = getTop(plays, 8);
      const topD = getTop(downs, 8);

      topPlayedEl.innerHTML = "";
      topDownloadedEl.innerHTML = "";

      if (!topP.length){
        topPlayedEl.innerHTML = `<div class="topEmpty">Hen√ºz dinlenme yok.</div>`;
      } else {
        for (const x of topP){
          const it = items.find(z => z.id === x.id);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "topItem";
          btn.innerHTML = `<span class="topTitle">${(it?.title || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</span><span class="topCount">${x.n}</span>`;
          btn.addEventListener("click", () => playById(x.id));
          topPlayedEl.appendChild(btn);
        }
      }

      if (!topD.length){
        topDownloadedEl.innerHTML = `<div class="topEmpty">Hen√ºz indirme yok.</div>`;
      } else {
        for (const x of topD){
          const it = items.find(z => z.id === x.id);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "topItem";
          btn.innerHTML = `<span class="topTitle">${(it?.title || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</span><span class="topCount">${x.n}</span>`;
          btn.addEventListener("click", () => downloadById(x.id));
          topDownloadedEl.appendChild(btn);
        }
      }
    }

    function downloadById(id){
      const it = items.find(x => x.id === id);
      if (!it) return;

      bump(downs, id);
      saveMap(LS.downs, downs);
      renderTop();

      const fileUrl = urlFor(it);
      const dlUrl = DL_PROXY + "?u=" + encodeURIComponent(fileUrl);

      const a = document.createElement("a");
      a.href = dlUrl;
      a.rel = "noopener";
      a.download = "";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    let pendingPlayStatId = null;
    playerEl.addEventListener("playing", () => {
      if (pendingPlayStatId && pendingPlayStatId === activeId){
        bump(plays, pendingPlayStatId);
        saveMap(LS.plays, plays);
        pendingPlayStatId = null;
        renderTop();
      }
    });

    // =========================
    // Helpers
    // =========================
    function normTR(s){
      return (s || "")
        .toLocaleLowerCase("tr")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/ƒ±/g, "i")
        .replace(/ƒ∞/g, "i")
        .replace(/√º/g, "u")
        .replace(/√∂/g, "o")
        .replace(/≈ü/g, "s")
        .replace(/√ß/g, "c")
        .replace(/ƒü/g, "g");
    }

    function guessMime(url){
      try{
        const p = new URL(url).pathname.toLowerCase();
        if (p.endsWith(".mp3")) return "audio/mpeg";
        if (p.endsWith(".m4a")) return "audio/mp4";
      }catch{}
      return "audio/*";
    }

    function urlFor(item){
      if (item.url) return item.url;
      const file = item.file || item.name || item.title || "";
      return new URL(file, BASE).toString();
    }

    function fmtDur(sec){
      if (!Number.isFinite(sec) || sec <= 0) return "‚Äî";
      sec = Math.round(sec);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      const mm = String(m).padStart(2, "0");
      const ss = String(s).padStart(2, "0");
      if (h > 0) return `${h}:${mm}:${ss}`;
      return `${mm}:${ss}`;
    }

    function parseEndDate(item){
      const raw0 = (item.file || item.title || "").toString();
      const lastPart = raw0.split("/").pop() || raw0;

      let s;
      try { s = decodeURIComponent(lastPart); } catch { s = lastPart; }

      s = s.replace(/\.(mp3|m4a|wav|aac|ogg|flac)$/i, "").trim();
      s = s.normalize("NFKC");
      s = s.replace(/\u00A0/g, " ");
      s = s.trim().replace(/[)\]\s]+$/g, "").trim();

      const m = s.match(/(\d{1,2})[.\-_\u00B7](\d{1,2})[.\-_\u00B7](\d{2}|\d{4})\s*$/);
      if (!m) return null;

      const dd = Number(m[1]);
      const mm = Number(m[2]);
      let yy = Number(m[3]);
      if (yy < 100) yy = 2000 + yy;

      if (!(dd >= 1 && dd <= 31 && mm >= 1 && mm <= 12)) return null;

      const t = Date.UTC(yy, mm - 1, dd);
      if (!Number.isFinite(t)) return null;

      const d = new Date(t);
      if (d.getUTCFullYear() !== yy || (d.getUTCMonth() + 1) !== mm || d.getUTCDate() !== dd) return null;

      return t;
    }

    // ‚úÖ SVG oklarƒ± saƒülam ≈üekilde set et
    const NS = "http://www.w3.org/2000/svg";
    function setArrow(svgEl, isAsc){
      const p1 = document.createElementNS(NS, "path");
      const p2 = document.createElementNS(NS, "path");
      if (isAsc){
        p1.setAttribute("d","M12 19V5");
        p2.setAttribute("d","M7 10l5-5 5 5");
      } else {
        p1.setAttribute("d","M12 5v14");
        p2.setAttribute("d","M7 14l5 5 5-5");
      }
      svgEl.replaceChildren(p1, p2);
    }

    function setSortIcons(){
      sortDurBtn.classList.remove("on");
      sortDateBtn.classList.remove("on");

      setArrow(sortDurIcon, durSortDir === "asc");
      setArrow(sortDateIcon, dateSortDir === "asc");

      if (sortMode === "dur") sortDurBtn.classList.add("on");
      if (sortMode === "date") sortDateBtn.classList.add("on");
    }

    sortDurBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (sortMode !== "dur") sortMode = "dur";
      else durSortDir = (durSortDir === "asc") ? "desc" : "asc";
      localStorage.setItem(LS.sortMode, sortMode);
      localStorage.setItem(LS.sortDirDur, durSortDir);
      setSortIcons();
      render();
    });

    sortDateBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (sortMode !== "date") sortMode = "date";
      else dateSortDir = (dateSortDir === "asc") ? "desc" : "asc";
      localStorage.setItem(LS.sortMode, sortMode);
      localStorage.setItem(LS.sortDirDate, dateSortDir);
      setSortIcons();
      render();
    });

    // =========================
    // Duration loader
    // =========================
    const durQueue = [];
    const durLoading = new Set();
    let durActive = 0;
    const DUR_CONCURRENCY = 2;
    let rerenderTimer = null;

    function scheduleRerender(){
      if (rerenderTimer) return;
      rerenderTimer = setTimeout(() => {
        rerenderTimer = null;
        render();
      }, 120);
    }

    function requestDuration(it){
      const id = it.id;
      if (durs[id] > 0) return;
      if (durLoading.has(id)) return;
      durLoading.add(id);
      durQueue.push(it);
      pumpDurationQueue();
    }

    function pumpDurationQueue(){
      while (durActive < DUR_CONCURRENCY && durQueue.length){
        const it = durQueue.shift();
        durActive++;
        loadDurationFor(it).catch(() => {}).finally(() => {
          durActive--;
          pumpDurationQueue();
        });
      }
    }

    function loadDurationFor(it){
      return new Promise((resolve, reject) => {
        const a = new Audio();
        a.preload = "metadata";
        a.crossOrigin = "anonymous";
        a.src = urlFor(it);

        let done = false;

        const cleanup = () => {
          a.removeEventListener("loadedmetadata", onMeta);
          a.removeEventListener("error", onErr);
          try { a.src = ""; } catch {}
        };

        const finish = (ok, err) => {
          if (done) return;
          done = true;
          cleanup();
          durLoading.delete(it.id);
          ok ? resolve() : reject(err || new Error("metadata error"));
        };

        const onMeta = () => {
          const dur = a.duration;
          if (Number.isFinite(dur) && dur > 0){
            durs[it.id] = dur;
            saveMap(LS.durs, durs);
            scheduleRerender();
          }
          finish(true);
        };

        const onErr = () => finish(false, new Error("metadata error"));

        a.addEventListener("loadedmetadata", onMeta, { once: true });
        a.addEventListener("error", onErr, { once: true });

        setTimeout(() => {
          if (!done) finish(false, new Error("timeout"));
        }, 12000);
      });
    }

    // =========================
    // Archive list fetch + cache
    // =========================
    function makeFingerprint(list){
      return list.map(x => x.file).sort().join("|");
    }

    function loadFromCache(){
      try{
        const raw = localStorage.getItem(LS.cacheItems);
        if(!raw) return false;
        const cached = JSON.parse(raw);
        if(!Array.isArray(cached)) return false;
        items = cached;
        render();
        return true;
      }catch{ return false; }
    }

    async function fetchFromArchive(){
      const metaUrl = `https://archive.org/metadata/${ARCHIVE_ID}?_=${Date.now()}`;
      const res = await fetch(metaUrl, { cache: "no-store" });
      if(!res.ok) throw new Error("metadata okunamadƒ±");
      const data = await res.json();

      const files = Array.isArray(data.files) ? data.files : [];
      const newItems = files
        .filter(f => {
          const name = (f.name || "").toLowerCase();
          return name.endsWith(".mp3") || name.endsWith(".m4a");
        })
        .map((f, idx) => {
          const file = f.name || "";
          let fallback = (file.split("/").pop() || file);
          try { fallback = decodeURIComponent(fallback); } catch {}

          const title =
            (f.title && String(f.title).trim()) ||
            (fallback && String(fallback).trim()) ||
            ("Kayƒ±t " + (idx + 1));

          const url = `https://archive.org/download/${ARCHIVE_ID}/${encodeURIComponent(file).replace(/%2F/g, "/")}`;
          const id = file || title;
          return { id, title, file, url };
        })
        .sort((a,b) => a.title.localeCompare(b.title, "tr"));

      const fp2 = makeFingerprint(newItems);
      if (fp2 === lastFp && items.length) return false;

      items = newItems;
      lastFp = fp2;

      localStorage.setItem(LS.cacheFp, fp2);
      localStorage.setItem(LS.cacheItems, JSON.stringify(items));

      render();
      return true;
    }

    async function loadItems(){
      statusEl.textContent = "Y√ºkleniyor...";

      const hadCache = loadFromCache();
      if (hadCache) statusEl.textContent = "G√ºncelleniyor...";

      try{
        await fetchFromArchive();
        statusEl.textContent = "";
      }catch(err){
        console.error(err);
        statusEl.textContent = hadCache ? "" : "Ar≈üivden kayƒ±tlar √ßekilemedi.";
      }

      setInterval(() => { fetchFromArchive().catch(() => {}); }, 180000);
    }

    // =========================
    // Filtering + sorting
    // =========================
    function getVisibleItems(){
      const q = normTR((searchEl.value || "").trim());

      let arr = items.filter(it => {
        if (q && !normTR(it.title).includes(q)) return false;
        if (filterFav && !favs[it.id]) return false;
        if (filterSel && !sels[it.id]) return false;
        return true;
      });

      if (sortMode === "dur"){
        const dir = (durSortDir === "asc") ? 1 : -1;
        arr.sort((a,b) => {
          const ha = (durs[a.id] > 0);
          const hb = (durs[b.id] > 0);
          if (ha !== hb) return ha ? -1 : 1;
          if (ha && hb){
            const da = durs[a.id];
            const db = durs[b.id];
            if (da !== db) return (da - db) * dir;
          }
          return a.title.localeCompare(b.title, "tr");
        });
      } else if (sortMode === "date"){
        const dir = (dateSortDir === "asc") ? 1 : -1;
        arr.sort((a,b) => {
          const ta = parseEndDate(a);
          const tb = parseEndDate(b);
          const ha = (ta !== null);
          const hb = (tb !== null);
          if (ha !== hb) return ha ? -1 : 1;
          if (ha && hb && ta !== tb) return (ta - tb) * dir;
          return a.title.localeCompare(b.title, "tr");
        });
      } else {
        arr.sort((a,b) => a.title.localeCompare(b.title, "tr"));
      }

      return arr;
    }

    function render(){
      const visible = getVisibleItems();
      metaEl.textContent = `G√∂r√ºn…ôn: ${visible.length} / Toplam: ${items.length}`;

      filterFavBtn.classList.toggle("on", filterFav);
      filterSelBtn.classList.toggle("on", filterSel);
      filterFavBtn.setAttribute("aria-pressed",  String(filterFav));
      filterSelBtn.setAttribute("aria-pressed",  String(filterSel));

      listEl.innerHTML = "";

      // ‚úÖ top hits
      renderTop();

      const toMeasure = (sortMode === "dur") ? items : visible;
      for (const it of toMeasure){
        if (!(durs[it.id] > 0)) requestDuration(it);
      }

      for (const it of visible){
        const row = document.createElement("div");
        row.className = "itemRow" + (it.id === activeId ? " active" : "");

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = it.title;

        const dur = document.createElement("div");
        dur.className = "dur";
        dur.textContent = (durs[it.id] > 0) ? fmtDur(durs[it.id]) : "‚Ä¶";

        const favBtn = iconButton("star", !!favs[it.id], "Favori");
        const selBtn = iconButton("check", !!sels[it.id], "Se√ß");
        const dlBtn  = iconButton("download", false, "ƒ∞ndir");

        favBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          favs[it.id] = !favs[it.id];
          saveMap(LS.favs, favs);
          render();
        });

        selBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          sels[it.id] = !sels[it.id];
          saveMap(LS.sels, sels);
          render();
        });

        dlBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          downloadById(it.id);
        });

        for (const b of [favBtn, selBtn, dlBtn]){
          b.addEventListener("pointerup", (e) => e.stopPropagation());
          b.addEventListener("pointerdown", (e) => e.stopPropagation());
        }

        row.appendChild(title);
        row.appendChild(dur);
        row.appendChild(favBtn);
        row.appendChild(selBtn);
        row.appendChild(dlBtn);

        row.addEventListener("click", () => playById(it.id));
        listEl.appendChild(row);
      }
    }

    function iconButton(kind, on, title){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "iconBtn" + (on ? " on" : "");
      btn.title = title;

      if (kind === "star"){
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="${on ? "currentColor" : "none"}" stroke="currentColor" stroke-width="2">
            <path d="M12 2l3.1 6.3 6.9 1-5 4.9 1.2 6.8L12 17.8 5.8 21l1.2-6.8-5-4.9 6.9-1L12 2z"/>
          </svg>`;
      } else if (kind === "check"){
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6L9 17l-5-5"/>
          </svg>`;
      } else if (kind === "download"){
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v12"/>
            <path d="M7 10l5 5 5-5"/>
            <path d="M5 21h14"/>
          </svg>`;
      }
      return btn;
    }

    // =========================
    // Playback
    // =========================
    function playById(id){
      const visible = getVisibleItems();
      const idx = visible.findIndex(x => x.id === id);
      if (idx === -1) return;
      playAtVisibleIndex(idx);
    }

    function playAtVisibleIndex(idx){
      const visible = getVisibleItems();
      const it = visible[idx];
      if (!it) return;

      statusEl.textContent = "";
      activeId = it.id;
      fpTitle.textContent = it.title;

      // ‚úÖ ‚Äúger√ßek dinlenme‚Äù i√ßin playing bekle
      pendingPlayStatId = it.id;

      render();

      const url = urlFor(it);
      const mime = guessMime(url);

      plyr.source = {
        type: "audio",
        title: it.title,
        sources: [{ src: url, type: mime }]
      };

      const currentSpeed = SPEEDS[speedIndex] || 1;

      const tryPlay = () => {
        plyr.speed = currentSpeed;
        const p = plyr.play();
        if (p && typeof p.catch === "function"){
          p.catch(() => {
            statusEl.textContent = "Oynatma ba≈ülatƒ±lamadƒ±. Player‚Äôdaki ‚ñ∂Ô∏é tu≈üuna bas.";
          });
        }
      };

      const onCanPlay = () => {
        playerEl.removeEventListener("canplay", onCanPlay);
        setTimeout(tryPlay, 50);
      };

      playerEl.addEventListener("canplay", onCanPlay);
      setTimeout(() => { if (playerEl.paused) tryPlay(); }, 600);
    }

    function playPrev(){
      const visible = getVisibleItems();
      if (!visible.length) return;
      let idx = visible.findIndex(x => x.id === activeId);
      if (idx === -1) idx = 0;
      idx = (idx - 1 + visible.length) % visible.length;
      playAtVisibleIndex(idx);
    }

    function playNext(){
      const visible = getVisibleItems();
      if (!visible.length) return;
      let idx = visible.findIndex(x => x.id === activeId);
      if (idx === -1) idx = 0;
      idx = (idx + 1) % visible.length;
      playAtVisibleIndex(idx);
    }

    prevBtn.addEventListener("click", playPrev);
    nextBtn.addEventListener("click", playNext);
    plyr.on("ended", () => { setTimeout(() => playNext(), 0); });

    document.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
      const inTyping = (tag === "input" || tag === "textarea");
      if (inTyping) return;

      if (e.code === "Space"){
        e.preventDefault();
        plyr.togglePlay();
      } else if (e.code === "ArrowLeft"){
        e.preventDefault();
        playPrev();
      } else if (e.code === "ArrowRight"){
        e.preventDefault();
        playNext();
      }
    });

    // =========================
    // Filters
    // =========================
    filterFavBtn.addEventListener("click", () => { filterFav = !filterFav; render(); });
    filterSelBtn.addEventListener("click", () => { filterSel = !filterSel; render(); });

    resetBtn.addEventListener("click", () => {
      filterFav = false;
      filterSel = false;
      searchEl.value = "";

      sortMode = "title";
      localStorage.setItem(LS.sortMode, sortMode);

      setSortIcons();
      render();
    });

    let pending = false;
    searchEl.addEventListener("input", () => {
      if (pending) return;
      pending = true;
      requestAnimationFrame(() => {
        pending = false;
        render();
      });
    });

    // =========================
    // DRAGGABLE PLAYER (t√ºm player) + clamp (zoom uyumlu) + drag sonrasƒ± click iptal
    // =========================
    function restorePlayerPos(){
      try{
        const s = JSON.parse(localStorage.getItem(LS.pos) || "null");
        if (!s) return;
        if (typeof s.x === "number" && typeof s.y === "number"){
          fp.style.left = s.x + "px";
          fp.style.top = s.y + "px";
          fp.style.bottom = "auto";
          fp.style.right = "auto";
        }
      }catch{}
    }

    function savePlayerPos(x,y){
      localStorage.setItem(LS.pos, JSON.stringify({x,y}));
    }

    function getViewportWH(){
      const vv = window.visualViewport;
      const vw = (vv && vv.width)  ? vv.width  : window.innerWidth;
      const vh = (vv && vv.height) ? vv.height : window.innerHeight;
      return { vw, vh };
    }

    function clampPlayerToViewport(){
      const { vw, vh } = getViewportWH();

      const w0 = fp.offsetWidth;
      const h0 = fp.offsetHeight;
      const w = useTransformScale ? (w0 * uiScale) : w0;
      const h = useTransformScale ? (h0 * uiScale) : h0;

      const minX = 8;
      const minY = 8;
      const maxX = Math.max(minX, vw - w - 8);
      const maxY = Math.max(minY, vh - h - 8);

      const left = parseFloat(fp.style.left);
      const top  = parseFloat(fp.style.top);
      if (!Number.isFinite(left) || !Number.isFinite(top)) return;

      const nx = Math.min(maxX, Math.max(minX, left));
      const ny = Math.min(maxY, Math.max(minY, top));

      fp.style.left = nx + "px";
      fp.style.top  = ny + "px";
      fp.style.right = "auto";
      fp.style.bottom = "auto";

      savePlayerPos(nx, ny);
    }

    const DRAG_IGNORE_SELECTOR =
      "button, a, input, textarea, select, option, " +
      ".speedWrap, .speedCtlBtn, .miniBtn, " +
      ".plyr__controls, .plyr__control, .plyr__progress, .plyr__seek, .plyr__volume, .plyr__time, .plyr__menu";

    function shouldStartDrag(target){
      return !(target && target.closest && target.closest(DRAG_IGNORE_SELECTOR));
    }

    let dragging = false;
    let startX = 0, startY = 0, startLeft = 0, startTop = 0;
    let moved = false;
    let suppressClickUntil = 0;

    fp.addEventListener("pointerdown", (e) => {
      if (!shouldStartDrag(e.target)) return;

      dragging = true;
      moved = false;

      fp.setPointerCapture(e.pointerId);
      fpHeader.style.cursor = "grabbing";

      const rect = fp.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      startLeft = rect.left;
      startTop = rect.top;

      fp.style.left = startLeft + "px";
      fp.style.top = startTop + "px";
      fp.style.bottom = "auto";
      fp.style.right = "auto";
    });

    fp.addEventListener("pointermove", (e) => {
      if (!dragging) return;

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if (!moved && (Math.abs(dx) + Math.abs(dy) > 6)) moved = true;

      const w0 = fp.offsetWidth;
      const h0 = fp.offsetHeight;
      const w = useTransformScale ? (w0 * uiScale) : w0;
      const h = useTransformScale ? (h0 * uiScale) : h0;

      const { vw, vh } = getViewportWH();

      const minX = 8;
      const minY = 8;
      const maxX = Math.max(minX, vw - w - 8);
      const maxY = Math.max(minY, vh - h - 8);

      const nx = Math.min(maxX, Math.max(minX, startLeft + dx));
      const ny = Math.min(maxY, Math.max(minY, startTop + dy));

      fp.style.left = nx + "px";
      fp.style.top = ny + "px";
      savePlayerPos(nx, ny);
    });

    function endDrag(pointerId){
      if (!dragging) return;

      dragging = false;
      fpHeader.style.cursor = "grab";

      try { fp.releasePointerCapture(pointerId); } catch {}
      clampPlayerToViewport();

      if (moved){
        suppressClickUntil = Date.now() + 350;
        moved = false;
      }
    }

    fp.addEventListener("pointerup", (e) => endDrag(e.pointerId));
    fp.addEventListener("pointercancel", (e) => endDrag(e.pointerId));

    fp.addEventListener("click", (e) => {
      if (Date.now() < suppressClickUntil){
        e.preventDefault();
        e.stopPropagation();
      }
    }, true);

    window.addEventListener("resize", () => clampPlayerToViewport());
    window.addEventListener("orientationchange", () => setTimeout(clampPlayerToViewport, 150));
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", () => clampPlayerToViewport());
    }

    // ‚úÖ NAV ACTIVE
    (function setActiveNav(){
      const here = location.href.replace(/\/$/, "");
      document.querySelectorAll(".navRow .navLink").forEach(a => {
        a.classList.remove("on");
        const u = (a.getAttribute("href") || "").replace(/\/$/, "");
        if (!u) return;
        if (here === u || here.startsWith(u + "/")) a.classList.add("on");
      });
    })();

    // Boot
    setSortIcons();
    restorePlayerPos();
    restoreSpeed();
    restoreZoom();
    setTimeout(clampPlayerToViewport, 0);
    loadItems();
  </script>
</body>
</html>
